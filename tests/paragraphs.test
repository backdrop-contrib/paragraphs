<?php
/**
 * Defines tests for paragraphs.
 */

 class ParagraphsWebTestCase extends BackdropWebTestCase {

  /**
   * A user object for the privileged user.
   *
   * @var object
   */
  protected $privilegedUser;

  public function setUp() {
    $modules = array(
      'paragraphs_test',
    );

    parent::setUp($modules);

    // Create a user with appropriate permissions and log them in.
    $this->privilegedUser = $this->backdropCreateUserWithRole('ptest_creator');
    $this->backdropLogin($this->privilegedUser);
  }

  /**
   * Tests creating and updating a node with paragraphs.
   */
  public function testNodeParagraphs() {

    $this->backdropLogin($this->privilegedUser);

    $this->backdropGet('node/add/paragraph-test');

    // Add a new paragraph before saving node.
    // $this->backdropPost(NULL, array(), t('Add new Paragraph'));
    $this->backdropPostAJAX(NULL, array(), array('field_paragraphs_add_more_add_more' => t('Add new Paragraph')));

    $title = $this->randomString(20);
    $value1 = $this->randomString(20);
    $create_edit = array(
      'title' => $title,
      'field_paragraphs[und][0][field_ptest_text][und][0][value]' => $value1,
    );
    $this->backdropPost(NULL, $create_edit, t('Save'));

    $this->assertRaw(t('!post %title has been created.', array('!post' => 'Paragraph Test', '%title' => $title)), 'Paragraph test node created.');
    $this->assertText(check_plain($value1), 'First value of paragraph was rendered.');

    // Update the created node.
    $node_url = $this->getUrl();
    $this->backdropGet($node_url . '/edit');

    $this->backdropPost(NULL, array(), t('Add another Paragraph'));

    $value2 = $this->randomString(20);
    $update_edit = array(
      'field_paragraphs[und][1][field_ptest_text][und][0][value]' => $value2,
    );
    $this->backdropPost(NULL, $update_edit, t('Save'));

    $this->assertRaw(t('!post %title has been updated.', array('!post' => 'Paragraph Test', '%title' => $title)), 'Paragraph test node updated.');
    $this->assertText(check_plain($value1), 'First value of paragraph was rendered.');
    $this->assertText(check_plain($value2), 'Second value of paragraph was rendered.');

  }

  /**
   * Tests required field validation on paragraph bundle.
   */
  public function testRequiredFieldInBundle() {
    $this->backdropLogin($this->privilegedUser);

    $this->backdropGet('node/add/paragraph-test');

    // Add a new paragraph before saving node.
    // $this->backdropPost(NULL, array(), t('Add new Paragraph'));
    $this->backdropPostAJAX(NULL, array(), array('field_paragraphs_add_more_add_more' => t('Add new Paragraph')));

    $title = $this->randomString(20);

    $create_edit = array(
      'title' => $title,
    );

    // Click the Save button to test whole-form validation.
    $this->backdropPost(NULL, $create_edit, t('Save'));

    // Empty field should fail validation.
    $this->assertRaw(t('!field field is required.', array('!field' => 'PTest Text')), 'Field failed whole-form validation');

    // Click the Collapse button to test per-paragraph validation.
    $this->backdropPost(NULL, $create_edit, t('Collapse'));

    // Empty field should fail validation.
    $this->assertRaw(t('!field field is required.', array('!field' => 'PTest Text')), 'Field failed per-paragraph validation');

    // Add value to field.
    $value1 = $this->randomString(20);
    $create_edit = array(
      'field_paragraphs[und][0][field_ptest_text][und][0][value]' => $value1,
    );

    // Click Collapse button to close paragraph (should now pass).
    $this->backdropPost(NULL, $create_edit, t('Collapse'));

    // Paragraph item should collapse after passing validation.
    $this->assertRaw(t('Warning: this content must be saved to reflect changes on this paragraphs item.'), 'Field passed per-paragraph validation');

    $create_edit = array(
      'title' => $title,
    );

    // Save whole node.
    $this->backdropPost(NULL, $create_edit, t('Save'));

    // Node should save.
    $this->assertRaw(t('!post %title has been created.', array('!post' => 'Paragraph Test', '%title' => $title)), 'Paragraph test node created.');
    $this->assertText(check_plain($value1), 'Value of paragraph was rendered.');
  }

  /**
   * Helper to create a user with a given role.
   *
   * @param string $role_name
   *   The name of the role to give the user.
   *
   * @return bool|object
   *   A user account object.
   *
   * @throws \Exception
   *
   * @see BackdropWebTestCase::backdropCreateUser()
   */
  protected function backdropCreateUserWithRole($role_name) {

    // Create a user assigned to that role.
    $account = backdrop_anonymous_user();
    $account->name = $this->randomName();
    $account->mail = $edit['name'] . '@example.com';
    $account->pass = user_password();
    $account->status = 1;
    $account->roles = array($role_name);

    $account = user_save($account);

    $this->assertTrue(!empty($account->uid), t('User created with name %name and pass %pass', array('%name' => $edit['name'], '%pass' => $edit['pass'])), t('User login'));
    if (empty($account->uid)) {
      return FALSE;
    }

    // Add the raw password so that we can log in as this user.
    $account->pass_raw = $account->pass;

    return $account;
  }
}

class ParagraphStatusVisibilityTestCase extends BackdropWebTestCase {

  const HOST_ENTITY_TYPE = 'paragraph-test';
  const BUNDLE_NAME = 'ptest';
  protected $privilegedUser;
  protected $hostEntityEditUrl;

  /**
   * Test paragraphs item visibility based on status.
   */
  public function setUp() {
    $modules = array(
      'paragraphs_test',
    );

    parent::setUp($modules);

    // Create a user with appropriate permissions and log them in.
    $this->privilegedUser = $this->backdropCreateUserWithRole('ptest_creator');
    $this->backdropLogin($this->privilegedUser);
  }

  /**
   * Status visibility for Paragraphs item.
   */
  public function testStatusVisibilityParagraphsItem() {
    // Create host entity with Paragraphs item.
    $this->backdropGet('node/add/' . $this::HOST_ENTITY_TYPE);
    // $this->backdropPost(NULL, array(), t('Add new Paragraph'));
    $this->backdropPostAJAX(NULL, array(), array('field_paragraphs_add_more_add_more' => t('Add new Paragraph')));

    $title = $this->randomString(20);
    $value1 = $this->randomString(20);

    $create_edit = array(
      'title' => $title,
      'field_paragraphs[und][0][field_ptest_text][und][0][value]' => $value1,
    );

    $this->backdropPost(NULL, $create_edit, t('Save'));

    // Ensure creation passed.
    $this->assertRaw(t('!post %title has been created.', array('!post' => 'Paragraph Test', '%title' => $title)), 'Paragraph test node created.');
    $this->assertText(check_plain($value1), 'Value of paragraphs item is visible.');

    // Get host entity edit url.
    $this->hostEntityEditUrl = $this->url . '/edit';

    // Change visibility of Paragraphs item.
    $this->backdropGet($this->hostEntityEditUrl);

    $create_edit = array(
      'field_paragraphs[und][0][status]' => FALSE,
    );

    $this->backdropPost(NULL, $create_edit, t('Save'));
    // Ensure paragraphs item not visible.
    $this->assertNoText(check_plain($value1), 'Value of paragraphs item is not visible.');
  }

  /**
   * Status visibility for Paragraphs bundle.
   */
  public function testStatusVisibilityParagraphsBundle() {
    // Ensure status enabled in bundle
    $this->backdropGet('admin/structure/paragraphs/' . $this::BUNDLE_NAME . '/edit');

    $create_edit = array(
      'allow_unpublish' => TRUE,
    );

    $this->backdropPost(NULL, $create_edit, t('Save Paragraph bundle'));

    // Ensure status enabled in paragraphs item form
    $this->backdropGet('node/add/' . $this::HOST_ENTITY_TYPE);
    // $this->backdropPost(NULL, array(), t('Add new Paragraph'));
    $this->backdropPostAJAX(NULL, array(), array('field_paragraphs_add_more_add_more' => t('Add new Paragraph')));
    $this->assertFieldChecked('edit-field-paragraphs-und-0-actions-togglepublish-button', 'Publish button exists.');

    // Disable status checkbox in bundle
    $this->backdropGet('admin/structure/paragraphs/' . $this::BUNDLE_NAME . '/edit');
    $create_edit = array(
      'allow_unpublish' => FALSE,
    );
    $this->backdropPost(NULL, $create_edit, t('Save Paragraph bundle'));

    // Ensure status disabled in paragraphs item form
    $this->backdropGet('node/add/' . $this::HOST_ENTITY_TYPE);
    // $this->backdropPost(NULL, array(), t('Add new Paragraph'));
    $this->backdropPostAJAX(NULL, array(), array('field_paragraphs_add_more_add_more' => t('Add new Paragraph')));
    $this->assertNoFieldById('edit-field-paragraphs-und-0-actions-togglepublish-button', 'Publish button not showing.');
  }
}
